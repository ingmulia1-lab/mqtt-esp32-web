<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control Oficina -LED- por ESP32 - Acceso</title>
  <!-- MQTT.js desde CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg: #0B2C4D;
      --on: #16a34a;
      --off: #b91c1c;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --panel: rgba(255,255,255,.06);
      --input-bg: rgba(255,255,255,.1);
      --input-bd: rgba(255,255,255,.2);
      --btn: #1e3a8a;
    }
    * { box-sizing: border-box; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      padding: 48px 16px 32px;
      margin: 0;
    }
    h1{ margin-bottom: 24px; }
    .panel{
      max-width: 560px;
      margin: 0 auto;
      background: var(--panel);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      opacity: 1;
      transition: opacity .15s ease;
    }
    button{
      padding: 14px 26px;
      font-size: 18px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: #fff;
      transition: transform .05s ease;
    }
    button:active { transform: translateY(1px) }
    .btn-on  { background: var(--on); }
    .btn-off { background: var(--off); }
    .row { margin-top: 8px; }
    .status{
      margin-top: 10px;
      font-size: 16px;
      color: var(--muted);
    }
    .status b{ color: #fff; }
    .led-indicator{
      width: 60px; height: 60px;
      border-radius: 50%;
      margin: 18px auto 8px;
      background: #c81e1e; /* rojo (apagado) */
      box-shadow: 0 0 18px #c81e1e;
      transition: all .2s ease-in-out;
      border: 2px solid rgba(255,255,255,.25);
    }
    .led-on{
      background: #22c55e !important;
      box-shadow: 0 0 22px #22c55e !important;
    }
    .footer{
      margin-top: 18px;
      font-size: 12px;
      color: var(--muted);
    }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ======== Modal de acceso ======== */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .login-box{
      width: 92%; max-width: 380px;
      background: #0f2742;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      padding: 20px 18px 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,.5);
      text-align: left;
    }
    .login-box h2{
      margin: 0 0 12px 0; font-size: 20px;
    }
    .field{
      display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px;
    }
    .field label{ font-size: 13px; color: #cbd5e1; }
    .field input{
      width: 100%; padding: 12px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-bd);
      color: #fff; border-radius: 10px; outline: none;
    }
    .login-actions{
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      margin-top: 6px;
    }
    .btn-primary{ background: var(--btn); }
    .msg-error{
      color: #fecaca; font-size: 13px; min-height: 18px; margin-top: 4px;
    }
    .remember{
      display: flex; align-items: center; gap: 8px; font-size: 13px; color: #cbd5e1;
      user-select: none;
    }
  </style>
</head>
<body>

  <h1>Control LED ESP32</h1>

  <div class="panel" id="panel-app" aria-hidden="true">
    <div class="row">
      <button class="btn-on"  onclick="encender()">Encender</button>
      <button class="btn-off" onclick="apagar()">Apagar</button>
    </div>

    <div class="led-indicator" id="led"></div>

    <div class="status">Conexión MQTT: <b id="conn">Desconectado</b></div>
    <div class="status">Estado LED Oficina: <b id="estado">N/D</b></div>
    <div class="status">Topic control: <code>ivan/esp32/led</code></div>
    <div class="status">Topic estado: <code>ivan/esp32/estado</code></div>
  </div>

  <!-- ===== Modal de acceso ===== -->
  <div class="overlay" id="loginOverlay" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="login-box">
      <h2 id="loginTitle">Acceso requerido</h2>
      <div class="field">
        <label for="user">Usuario</label>
        <input type="text" id="user" placeholder="usuario" autocomplete="username" />
      </div>
      <div class="field">
        <label for="pass">Contraseña</label>
        <input type="password" id="pass" placeholder="contraseña" autocomplete="current-password" />
      </div>
      <div class="login-actions">
        <div class="remember">
          <input type="checkbox" id="remember" />
          <label for="remember">Recordar en esta sesión</label>
        </div>
        <button class="btn-primary" id="btnLogin">Entrar</button>
      </div>
      <div class="msg-error" id="loginMsg"></div>
    </div>
  </div>

  <div class="footer">
    Tarea 1 Parcial 2 - MQTT sobre WebSockets (TLS) usando · HiveMQ Cloud y ESP32 Internet · Ejemplo educativo
  </div>

  <script>
    // ============ CONFIG (ajusta sólo si cambiaste tu instancia/credenciales) ============
    const BROKER_URL = "wss://3759e23402c4448584ca5389cdd951e9.s1.eu.hivemq.cloud:8884/mqtt";
    const MQTT_USER  = "IvanMulia";
    const MQTT_PASS  = "Musiol1980";

    const TOPIC_CTRL = "ivan/esp32/led";     // Web -> ESP32: "ON"/"OFF"
    const TOPIC_STAT = "ivan/esp32/estado";  // ESP32 -> Web: "ON"/"OFF"

    // ============ Credenciales de acceso al panel (solicitado) ============
    const APP_USER = "ivan";
    const APP_PASS = "1234";

    // ============ Referencias UI ============
    const elConn   = document.getElementById("conn");
    const elEstado = document.getElementById("estado");
    const elLed    = document.getElementById("led");
    const panelApp = document.getElementById("panel-app");

    const loginOverlay = document.getElementById("loginOverlay");
    const userInput    = document.getElementById("user");
    const passInput    = document.getElementById("pass");
    const btnLogin     = document.getElementById("btnLogin");
    const loginMsg     = document.getElementById("loginMsg");
    const rememberCb   = document.getElementById("remember");

    let client = null;
    let authenticated = false;

    // ================== Lógica de Acceso ==================
    function showLogin() {
      loginOverlay.style.display = "flex";
      panelApp.style.opacity = 0.35;
      panelApp.setAttribute("aria-hidden", "true");
      userInput.focus();
    }
    function hideLogin() {
      loginOverlay.style.display = "none";
      panelApp.style.opacity = 1;
      panelApp.removeAttribute("aria-hidden");
    }
    function checkRemembered() {
      try {
        const ok = sessionStorage.getItem("app-auth-ok");
        if (ok === "1") {
          authenticated = true;
          hideLogin();
          startMqtt(); // conecta de inmediato si la sesión ya está recordada
        }
      } catch (e) { /* ignore */ }
    }
    function doLogin() {
      const u = (userInput.value || "").trim();
      const p = passInput.value || "";
      if (u === APP_USER && p === APP_PASS) {
        authenticated = true;
        loginMsg.textContent = "";
        hideLogin();
        if (rememberCb.checked) {
          try { sessionStorage.setItem("app-auth-ok", "1"); } catch(e){}
        }
        startMqtt(); // Sólo conectamos a MQTT después de autenticación
      } else {
        authenticated = false;
        loginMsg.textContent = "Usuario o contraseña incorrectos.";
        passInput.select();
        passInput.focus();
      }
    }
    btnLogin.addEventListener("click", doLogin);
    passInput.addEventListener("keydown", (ev)=>{ if (ev.key === "Enter") doLogin(); });
    window.addEventListener("load", () => {
      showLogin();
      checkRemembered();
    });

    // ============ MQTT (se inicia sólo tras login correcto) ============
    function startMqtt(){
      if (!authenticated) return;
      if (!window.mqtt) {
        elConn.textContent = "MQTT.js no cargó";
        return;
      }
      // Conexión segura WSS (HiveMQ Cloud)
      client = mqtt.connect(BROKER_URL, {
        clientId: "webclient-" + Math.random().toString(16).slice(2),
        username: MQTT_USER,
        password: MQTT_PASS,
        clean: true,
        reconnectPeriod: 1500,
        connectTimeout: 30000,
      });

      client.on("connect", () => {
        elConn.textContent = "Conectado ✅";
        client.subscribe(TOPIC_STAT, { qos: 1 }, (err) => {
          if (err) console.error("Error al suscribir:", err);
        });
      });

      client.on("reconnect", () => {
        elConn.textContent = "Reconectando…";
      });

      client.on("close", () => {
        elConn.textContent = "Desconectado";
      });

      client.on("error", (err) => {
        elConn.textContent = "Error ❌";
        console.error(err);
      });

      client.on("message", (topic, payload) => {
        if (topic === TOPIC_STAT) {
          const msg = String(payload).trim().toUpperCase();
          elEstado.textContent = msg || "N/D";
          if (msg === "ON") elLed.classList.add("led-on");
          else elLed.classList.remove("led-on");
        }
      });
    }

    // ============ Acciones ============
    function encender(){
      if (!client || !client.connected) return;
      client.publish(TOPIC_CTRL, "ON", { qos: 1, retain: false });
    }
    function apagar(){
      if (!client || !client.connected) return;
      client.publish(TOPIC_CTRL, "OFF", { qos: 1, retain: false });
    }

    // Exponer global (para los botones)
    window.encender = encender;
    window.apagar   = apagar;
  </script>
</body>
</html>
